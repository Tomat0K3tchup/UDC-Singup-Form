<script type="module">
  import {
    LitElement,
    css,
    html,
  } from "https://cdn.jsdelivr.net/gh/lit/dist@3/core/lit-core.min.js";
  import SignaturePad from "https://cdn.jsdelivr.net/npm/signature_pad@5.0.4/+esm";

  export class FormSignature extends window.FormInput {
    static styles = [
      window.FormInput.styles,
      css`
        canvas {
          width: 100%;
          height: 100%;
        }

        .sigWrapper {
          width: 50%;
          height: 5rem;
          border: 1px solid var(--main-bg-color);
          border-radius: 2px;
        }
      `,
    ];

    firstUpdated() {
      super.firstUpdated();
      this.$canvas = this.shadowRoot.querySelector("canvas");

      this.signaturePad = new SignaturePad(this.$canvas, {
        penColor: "#145394",
      });

      window.addEventListener("resize", () => this.resizeCanvas());
      this.resizeCanvas();

      this.signaturePad.addEventListener("endStroke", () => {
        console.log("Signature finished");
      });
    }

    updateValue(e) {
      this.value = this.signaturePad.toDataURL();
    }

    resizeCanvas() {
      const ratio = Math.max(window.devicePixelRatio || 1, 1);
      this.$canvas.width = this.$canvas.offsetWidth * ratio;
      this.$canvas.height = this.$canvas.offsetHeight * ratio;
      this.$canvas.getContext("2d").scale(ratio, ratio);
      this.signaturePad.clear(); // otherwise isEmpty() might return incorrect value
    }

    clear() {
      this.signaturePad.clear();
      console.log("cleared");
    }

    save() {
      if (this.signaturePad.isEmpty()) {
        return alert("Please provide a signature first.");
      }

      var data = this.signaturePad.toDataURL("image/png");
      console.log(data);
      window.open(data);
    }

    render() {
      return html`
        <div>
          <button @click=${this.clear}>Clear</button>
        </div>
        <div class="sigWrapper">
          <canvas class="newPad"></canvas>
          <input type="hidden" id="sigOutput2" name="output" class="output" />
        </div>
      `;
    }
  }

  customElements.define("form-signature", FormSignature);
</script>
