<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><?= data.title ?></title>
    <base target="_top" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css"
      integrity="sha512-NhSC1YmyruXifcj/KFRWoC561YpHpc5Jtzgvbuzx5VozKpWvQ+4nXhPdFgmx8xqexRcpAglTj9sIBWINXa8x5w=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />

    <?!= include_('dist/frontend/stylesheet') ?>

    <!-- <script>
      // Prevent forms from submitting.
      function preventFormSubmit() {
        const $form = document.getElementById("udc-form");
        $form.addEventListener("submit", function (event) {
          event.preventDefault();
        });
      }

      window.addEventListener("load", preventFormSubmit);

      function handleFormSubmit(formObject) {
        console.log("called");
        var formData = new FormData(formObject);
        var payload = Object.fromEntries(formData);

        // payload["phone"] = phoneInputHandler.getNumber();
        // payload["em_phone"] = emPhoneInputHandler.getNumber();

        console.log(payload);
        toggleSpinner();
        google.script.run.withSuccessHandler(handleSuccess).processForm(payload);
      }

      function toggleSpinner() {
        document.querySelector("spinner-modal").toggle();
      }

      function handleSuccess() {
        console.log(document.querySelector("multi-step-form"));
        document.querySelector("multi-step-form").style.display = "none";
        document.querySelector("success-failure-display").toggleVisibility();
        toggleSpinner();
      }
    </script> -->
  </head>
  <body>
    <div class="formWidth formDropShadow">
      <!-- <form name="udc-form" enctype="multipart/form-data" id="udc-form" onsubmit="handleFormSubmit(this)"> -->
      <div class="formWrapper">
        <div class="zf-tempHeadContBdr">
          <h1><em data-i18n="title"></em></h1>
          <!-- <p class="zf-frmDesc">Please give accurate information.</p> -->
        </div>

        <!-- <multi-step-form>
            <input type="hidden" value="<?= JSON.stringify(data.form) ?>" id="prefill" />

            <fieldset class="formStep">
              <legend data-i18n="personal.title"></legend>
              <div class="multiInput" id="full_name">
                <form-input data-i18n="[label]personal.firstName" id="first_name" required></form-input>
                <form-input data-i18n="[label]personal.lastName" id="last_name" required></form-input>
              </div>
              <date-picker data-i18n="[label]personal.dob" id="dob" required></date-picker>
              <form-input data-i18n="[label]personal.email" id="email" type="email" required></form-input>
              <form-input data-i18n="[label]personal.address" id="address" required></form-input>

              <div class="formInput">
                <div>
                  <label for="phone" data-i18n="[prepend]personal.phone"
                    ><em class="important">*</em></label
                  >
                  <input id="phone" name="phone" type="tel" required />
                </div>
                <span id="phone_err" class="error invalid">Please enter a phone number.</span>
              </div>
            </fieldset>

            <!--<fieldset class="formStep">
              <legend data-i18n="[label]emergency.title">Emergency Contact</legend>
              <form-input data-i18n="[label]emergency.fullName" id="em_full_name" required></form-input>

              <div class="formInput">
                <div>
                  <label for="em_phone" data-i18n="[prepend]emergency.phone"
                    ><em class="important">*</em></label
                  >
                  <input id="em_phone" name="em_phone" type="tel" required />
                </div>
                <!-- FIXME: plain text
                <span id="phone_err" class="error invalid">Please enter a phone number.</span>
              </div>

              <form-input label="Relationship" id="em_relationship" required></form-input>

              <form-accordion>
                <form-radio
                  id="di"
                  slot="decision"
                  data-i18n="[label]emergency.di.label;[options]emergency.di.options"
                  required
                ></form-radio>
                <fieldset id="di_hidden" class="flx-form" slot="hidden">
                  <form-input data-i18n="[label]emergency.diProvider" id="di_provider"></form-input>
                  <form-input data-i18n="[label]emergency.diPolicyNb" id="di_policy_nb"></form-input>
                  <form-input data-i18n="[label]emergency.diOther" id="di_other"></form-input>
                </fieldset>
              </form-accordion>
            </fieldset>

            <fieldset class="formStep">
              <legend data-i18n="id.title"></legend>
              <div class="formInput">
                <label for="id_country" data-i18n="id.country"><em class="important">*</em></label>
                <?!= include_('dist/frontend/components/CountrySelect') ?>
              </div>
              <form-input data-i18n="[label]id.number" id="id_nb" required></form-input>
              
              <div class="multiInput">
                <date-picker data-i18n="[label]id.issDate" id="id_iss_date" type="date" required></date-picker>
                <date-picker data-i18n="[label]id.expDate" id="id_exp_date" type="date" required></date-picker>
              </div>

            </fieldset> 

            <fieldset class="formStep legal">
              <?!= include_('dist/frontend/layouts/TAndC') ?>
              <form-input data-i18n="[label]tAndC.accept" id="id_t_c" type="checkbox" required></form-input>
            </fieldset>

            <!-- <fieldset class="formStep legal">
              <?!= include_('dist/frontend/layouts/SafeDiving') ?>
              <form-signature
                id="signature"
                data-i18n="[label]liability.signature"
                required
              ></form-signature>
            </fieldset> 

            <fieldset id="liabilityStep" class="formStep legal">
              <liability-layout></liability-layout>
              <form-signature
                id="signature"
                data-i18n="[label]liability.signature"
                required
              ></form-signature>
            </fieldset>
          </multi-step-form> -->
        <section>
          <p>Pick your course</p>
          <div>
            <a href="<?= ScriptApp.getService().getUrl() + '/medical'?>">Medical</a>
            <a
              href="https://script.google.com/macros/s/AKfycby3STqolbuRf7cXKuAsZjwLqUON9zZ69p-1Gu9xVEg/dev/liability"
              >Liability</a
            >
            <a
              href="https://script.google.com/macros/s/AKfycby3STqolbuRf7cXKuAsZjwLqUON9zZ69p-1Gu9xVEg/dev/safeDiving"
              >Safe Diving</a
            >
            <a
              href="https://script.google.com/macros/s/AKfycby3STqolbuRf7cXKuAsZjwLqUON9zZ69p-1Gu9xVEg/dev/tAndC"
              >Terms and Conditions</a
            >
          </div>
        </section>
        <spinner-modal></spinner-modal>
        <success-failure-display></success-failure-display>
      </div>
      <!-- </form> -->
    </div>

    <!-- prettier-ignore -->
    <?!= include_('dist/locales')?> 
    <?!= include_('dist/frontend/i18n') ?>

    <script
      type="module"
      src="https://cdn.jsdelivr.net/npm/@duetds/date-picker@1.4.0/dist/duet/duet.esm.js"
    ></script>

    <!-- Import custom components -->
    <!-- prettier-ignore -->
    <?!= include_('dist/frontend/components/FormInput') ?> 
    <?!= include_('dist/frontend/components/FormTab') ?> 
    <?!= include_('dist/frontend/components/FormRadio') ?> 
    <?!= include_('dist/frontend/components/FormAccordion') ?>
    <?!= include_('dist/frontend/components/FormSignature') ?>
    <?!= include_('dist/frontend/components/SpinnerModal') ?>
    <?!= include_('dist/frontend/components/SuccessFailureDisplay') ?>
    <?!= include_('dist/frontend/components/DatePicker') ?>

    <!-- Import custom layouts -->
    <!-- prettier-ignore -->
    <?!= include_('dist/frontend/layouts/Liability') ?>

    <!-- Prefill form value based on specific ulr params -->
    <script>
      const prefillData = JSON.parse(document.getElementById("prefill").value);
      document.addEventListener("DOMContentLoaded", () => {
        Object.keys(prefillData).forEach((id) => {
          document.getElementById(id).value = prefillData[id];
        });
      });
    </script>

    <!-- IntTelInput -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/intl-tel-input@25.2.1/build/css/intlTelInput.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@25.2.1/build/js/intlTelInputWithUtils.min.js"></script>
    <script>
      const $phoneInput = document.querySelector("#phone");
      const $phoneInputErr = document.querySelector("#phone_err");
      const $emPhoneInput = document.querySelector("#em_phone");
      const itiOptions = {
        initialCountry: "auto",
        preferredCountries: ["us", "ca", "uk", "fr", "de", "hn", "nl", "be", "ch"],
        geoIpLookup: _getCountryFromBrowser,
        formatAsYouType: true,
      };

      $phoneInput.addEventListener("invalid", function (event) {
        $phoneInput.classList.add("invalid");
        $phoneInputErr.classList.add("visible");
      });

      $phoneInput.addEventListener("input", function (event) {
        $phoneInput.classList.remove("invalid");
        $phoneInputErr.classList.remove("visible");
      });

      function _getCountryFromBrowser(callback) {
        const langCountryCode = navigator.languages ? navigator.languages[0] : navigator.language;

        if (!langCountryCode) {
          callback("us");
          return;
        }

        try {
          const lang = langCountryCode.split("-")[1].toLowerCase();
          callback(lang);
        } catch (error) {
          callback(langCountryCode);
        }
      }

      //TODO: reorder preferred languages list alphabetically
      const phoneInputHandler = window.intlTelInput($phoneInput, itiOptions);
      const emPhoneInputHandler = window.intlTelInput($emPhoneInput, itiOptions);

      // customElements.whenDefined("duet-date-picker").then(() => {
      //   document.querySelector("duet-date-picker").show();
      // });
    </script>

    <!-- Auto-fill the liability page with the customer's full name from the personal details -->
    <script>
      document.addEventListener("activated", mirrorFullNameLiability);
      function mirrorFullNameLiability(e) {
        if (!e.target.id == "liabilityStep") return;
        const $fullNameContainer = document.getElementById("full_name");
        const $inputs = $fullNameContainer.querySelectorAll("form-input");

        const fullName = $inputs[0].value + " " + $inputs[1].value;
        const $nodesToReplace = document.getElementsByClassName("liabilityName");

        Array.from($nodesToReplace).forEach(($node) => {
          $node.innerHTML = fullName;
        });
      }
    </script>
  </body>
</html>
